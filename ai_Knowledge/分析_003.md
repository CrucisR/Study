# Gemini CLI äº”å¤§æ¨¡å¼æƒé™åˆ†ææŠ¥å‘Š

## æ–‡æ¡£ä¿¡æ¯
- **ç”Ÿæˆæ—¥æœŸ**: 2026-02-03
- **ç‰ˆæœ¬**: 1.0
- **åˆ†æèŒƒå›´**: å‘½ä»¤æ‰§è¡Œæƒé™ã€æ–‡ä»¶æ“ä½œæƒé™ã€é»‘ç™½åå•æœºåˆ¶ã€å®‰å…¨æ£€æŸ¥å™¨

---

## ç›®å½•
1. [äº”å¤§æ¨¡å¼æ¦‚è¿°](#äº”å¤§æ¨¡å¼æ¦‚è¿°)
2. [å‘½ä»¤æ‰§è¡Œæƒé™åˆ†æ](#å‘½ä»¤æ‰§è¡Œæƒé™åˆ†æ)
3. [æ–‡ä»¶æ“ä½œæƒé™åˆ†æ](#æ–‡ä»¶æ“ä½œæƒé™åˆ†æ)
4. [é»‘ç™½åå•æœºåˆ¶](#é»‘ç™½åå•æœºåˆ¶)
5. [å®‰å…¨æ£€æŸ¥å™¨æœºåˆ¶](#å®‰å…¨æ£€æŸ¥å™¨æœºåˆ¶)
6. [è·¨æ¨¡å¼æƒé™å¯¹æ¯”è¡¨](#è·¨æ¨¡å¼æƒé™å¯¹æ¯”è¡¨)
7. [å®‰å…¨é˜²æŠ¤ç­–ç•¥æ€»ç»“](#å®‰å…¨é˜²æŠ¤ç­–ç•¥æ€»ç»“)

---

## äº”å¤§æ¨¡å¼æ¦‚è¿°

### æ¨¡å¼å®šä¹‰

Gemini CLI å®é™…ä¸Šå®šä¹‰äº† **å››ç§æ ¸å¿ƒå®¡æ‰¹æ¨¡å¼**ï¼ˆApprovalModeï¼‰ï¼Œç”¨æˆ·å¸¸è¯´çš„"Shell Mode"å¹¶éç‹¬ç«‹æ¨¡å¼ï¼Œè€Œæ˜¯æŒ‡ Shell å‘½ä»¤æ‰§è¡Œå·¥å…·åœ¨å„æ¨¡å¼ä¸‹çš„è¡¨ç°ã€‚

| æ¨¡å¼åç§° | æšä¸¾å€¼ | å¯åŠ¨æ–¹å¼ | ä¸»è¦ç”¨é€” | å®‰å…¨çº§åˆ« |
|---------|---------|---------|---------|---------|
| **Default Mode** | `default` | é»˜è®¤å¯åŠ¨ | äººæœºåä½œï¼Œæœ€å°æƒé™åŸåˆ™ | é«˜ |
| **AutoEdit Mode** | `autoEdit` | `--approval-mode=auto_edit` | è‡ªåŠ¨æ‰¹å‡†ç¼–è¾‘æ“ä½œ | ä¸­ |
| **YOLO Mode** | `yolo` | `--yolo` æˆ– `--approval-mode=yolo` | å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€ç¡®è®¤ | ä½ |
| **Plan Mode** | `plan` | `--approval-mode=plan` | åªè¯»è§„åˆ’æ¨¡å¼ | æœ€é«˜ |
| **Shell Mode** | (éç‹¬ç«‹æ¨¡å¼) | `gemini shell` | äº¤äº’å¼ Shell REPL | ä¾èµ–å½“å‰æ¨¡å¼ |

### ä»£ç ä½ç½®
- **æšä¸¾å®šä¹‰**: [packages/core/src/policy/types.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/types.ts#L74-L78)
- **æ¨¡å¼åˆ‡æ¢**: [packages/cli/src/config/config.ts](file:///d:/Code_AI/gemini-cli/packages/cli/src/config/config.ts#L596-L614)

---

## å‘½ä»¤æ‰§è¡Œæƒé™åˆ†æ

### 1. Shell å·¥å…·å®šä¹‰

**ä¸»è¦å·¥å…·**: `run_shell_command` (ä¹Ÿç§°ä¸º `ShellTool`)

**å·¥å…·å‚æ•°**:
```typescript
interface ShellToolParams {
  command: string;        // è¦æ‰§è¡Œçš„å‘½ä»¤å­—ç¬¦ä¸²
  description?: string;    // å‘½ä»¤æè¿°
  dir_path?: string;       // æ‰§è¡Œç›®å½•ï¼ˆå¯é€‰ï¼‰
}
```

**ä»£ç ä½ç½®**: [packages/core/src/tools/shell.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/tools/shell.ts#L1-L200)

### 2. äº”å¤§æ¨¡å¼ä¸‹çš„ Shell æƒé™

#### Default Modeï¼ˆé»˜è®¤æ¨¡å¼ï¼‰

**ç­–ç•¥é…ç½®**: [write.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/write.toml#L50-L52)

```toml
[[rule]]
toolName = "run_shell_command"
decision = "ask_user"
priority = 10
```

**æƒé™è¡¨ç°**:
- **å†³ç­–**: `ASK_USER`ï¼ˆè¯¢é—®ç”¨æˆ·ï¼‰
- **å¯æ‰§è¡Œå‘½ä»¤**: æ‰€æœ‰å‘½ä»¤ï¼Œä½†éœ€è¦ç”¨æˆ·ç¡®è®¤
- **é‡å®šå‘**: ä¸å…è®¸ï¼ˆé™çº§ä¸º ASK_USERï¼‰
- **è·¯å¾„é™åˆ¶**: é€šè¿‡ `validatePathAccess` é™åˆ¶åœ¨å·¥ä½œåŒºå†…

**æ‰§è¡Œæµç¨‹**:
```
ç”¨æˆ·è¯·æ±‚ â†’ ç­–ç•¥åŒ¹é… (ask_user) â†’ ç”¨æˆ·ç¡®è®¤ â†’ æ‰§è¡Œå‘½ä»¤
```

#### AutoEdit Modeï¼ˆè‡ªåŠ¨ç¼–è¾‘æ¨¡å¼ï¼‰

**ç­–ç•¥é…ç½®**: æ— ç‰¹æ®Šè§„åˆ™ï¼Œç»§æ‰¿ Default æ¨¡å¼çš„ `ask_user` ç­–ç•¥

**æƒé™è¡¨ç°**:
- **å†³ç­–**: `ASK_USER`ï¼ˆè¯¢é—®ç”¨æˆ·ï¼‰
- **å¯æ‰§è¡Œå‘½ä»¤**: æ‰€æœ‰å‘½ä»¤ï¼Œä½†éœ€è¦ç”¨æˆ·ç¡®è®¤
- **é‡å®šå‘**: ä¸å…è®¸ï¼ˆé™çº§ä¸º ASK_USERï¼‰
- **è·¯å¾„é™åˆ¶**: é€šè¿‡ `validatePathAccess` é™åˆ¶åœ¨å·¥ä½œåŒºå†…

**æ³¨æ„**: AutoEdit æ¨¡å¼åªæå‡äº† `write_file` å’Œ `replace` å·¥å…·çš„æƒé™ï¼Œ**æœªæå‡** `run_shell_command` çš„æƒé™ã€‚

#### YOLO Modeï¼ˆè‡ªåŠ¨æ‰¹å‡†æ¨¡å¼ï¼‰

**ç­–ç•¥é…ç½®**: [yolo.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/yolo.toml#L28-L32)

```toml
[[rule]]
decision = "allow"
priority = 999
modes = ["yolo"]
allow_redirection = true
```

**æƒé™è¡¨ç°**:
- **å†³ç­–**: `ALLOW`ï¼ˆè‡ªåŠ¨å…è®¸ï¼‰
- **å¯æ‰§è¡Œå‘½ä»¤**: æ‰€æœ‰å‘½ä»¤ï¼Œæ— éœ€ç¡®è®¤
- **é‡å®šå‘**: å…è®¸
- **è·¯å¾„é™åˆ¶**: é€šè¿‡ `validatePathAccess` é™åˆ¶åœ¨å·¥ä½œåŒºå†…

**æ‰§è¡Œæµç¨‹**:
```
ç”¨æˆ·è¯·æ±‚ â†’ ç­–ç•¥åŒ¹é… (allow, priority 999) â†’ ç›´æ¥æ‰§è¡Œ
```

#### Plan Modeï¼ˆè§„åˆ’æ¨¡å¼ï¼‰

**ç­–ç•¥é…ç½®**: [plan.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/plan.toml#L28-L32)

```toml
# Catch-All: Deny everything by default in Plan mode.
[[rule]]
decision = "deny"
priority = 20
modes = ["plan"]
```

**æƒé™è¡¨ç°**:
- **å†³ç­–**: `DENY`ï¼ˆæ‹’ç»ï¼‰
- **å¯æ‰§è¡Œå‘½ä»¤**: æ— ï¼ˆå®Œå…¨ç¦æ­¢ï¼‰
- **é‡å®šå‘**: ä¸é€‚ç”¨
- **è·¯å¾„é™åˆ¶**: ä¸é€‚ç”¨

**å…è®¸çš„å·¥å…·**ï¼ˆä»…é™ Plan æ¨¡å¼ï¼‰:
- `glob` - æ–‡ä»¶æœç´¢
- `search_file_content` - æ–‡ä»¶å†…å®¹æœç´¢
- `list_directory` - åˆ—å‡ºç›®å½•
- `read_file` - è¯»å–æ–‡ä»¶
- `google_web_search` - ç½‘ç»œæœç´¢
- `ask_user` - è¯¢é—®ç”¨æˆ·
- `write_file` - ä»…é™ `.gemini/tmp/.../plans/*.md`ï¼ˆé€šè¿‡ argsPatternï¼‰

#### Shell Modeï¼ˆäº¤äº’å¼ Shellï¼‰

**æƒé™è¡¨ç°**:
- **å†³ç­–**: ä¾èµ–å½“å‰æ¿€æ´»çš„ ApprovalModeï¼ˆé€šå¸¸æ˜¯ Default æˆ– YOLOï¼‰
- **å¯æ‰§è¡Œå‘½ä»¤**: æ ¹æ®å½“å‰æ¨¡å¼å†³å®š
- **é‡å®šå‘**: æ ¹æ®å½“å‰æ¨¡å¼å†³å®š
- **è·¯å¾„é™åˆ¶**: æ ¹æ®å½“å‰æ¨¡å¼å†³å®š

**æ³¨æ„**: Shell Mode ä¸æ˜¯ç‹¬ç«‹çš„ ApprovalModeï¼Œè€Œæ˜¯ UI äº¤äº’çŠ¶æ€ã€‚

### 3. å‘½ä»¤æ‰§è¡Œé˜²æŠ¤æœºåˆ¶

#### 3.1 è·¯å¾„è®¿é—®æ§åˆ¶

**æ ¸å¿ƒå‡½æ•°**: `validatePathAccess(absolutePath)`

**ä»£ç ä½ç½®**: [packages/core/src/tools/shell.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/tools/shell.ts#L186-L194)

```typescript
const cwd = this.params.dir_path
  ? path.resolve(this.config.getTargetDir(), this.params.dir_path)
  : this.config.getTargetDir();

const validationError = this.config.validatePathAccess(cwd);
if (validationError) {
  return {
    llmContent: validationError,
    returnDisplay: 'Path not in workspace.',
    error: {
      message: validationError,
      type: ToolErrorType.PATH_NOT_IN_WORKSPACE,
    },
  };
}
```

**å®ç°åŸç†**: ä½¿ç”¨ `isSubpath` å‡½æ•°æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨å…è®¸çš„å·¥ä½œåŒºå†…

**ä»£ç ä½ç½®**: [packages/core/src/utils/paths.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/utils/paths.ts#L335-L350)

```typescript
export function isSubpath(parentPath: string, childPath: string): boolean {
  const relative = path.relative(parentPath, childPath);
  return (
    relative === '' ||
    (!relative.startsWith('..') && !path.isAbsolute(relative))
  );
}
```

**é˜²æŠ¤æ•ˆæœ**:
- âœ… é˜²æ­¢ç›´æ¥è®¿é—®å·¥ä½œåŒºå¤–çš„è·¯å¾„ï¼ˆå¦‚ `/etc/passwd`ï¼‰
- âœ… é˜²æ­¢é€šè¿‡ `../` è·¯å¾„éå†æ”»å‡»
- âœ… é˜²æ­¢é€šè¿‡ç»å¯¹è·¯å¾„è®¿é—®ç³»ç»Ÿæ–‡ä»¶

#### 3.2 å‘½ä»¤é‡å®šå‘æ§åˆ¶

**æ ¸å¿ƒå‡½æ•°**: `shouldDowngradeForRedirection(command, allowRedirection)`

**ä»£ç ä½ç½®**: [packages/core/src/policy/policy-engine.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policy-engine.ts#L140-L147)

```typescript
private shouldDowngradeForRedirection(
  command: string,
  allowRedirection?: boolean,
): boolean {
  return (
    !allowRedirection &&
    hasRedirection(command) &&
    this.approvalMode !== ApprovalMode.AUTO_EDIT &&
    this.approvalMode !== ApprovalMode.YOLO
  );
}
```

**é‡å®šå‘æ£€æµ‹**: [packages/core/src/utils/shell-utils.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/utils/shell-utils.ts)

```typescript
export function hasRedirection(command: string): boolean {
  return /[>|<]/.test(command);
}
```

**é˜²æŠ¤æ•ˆæœ**:
- âœ… é˜²æ­¢é€šè¿‡ `>` é‡å®šå‘å†™å…¥å·¥ä½œåŒºå¤–æ–‡ä»¶
- âœ… é˜²æ­¢é€šè¿‡ `<` è¯»å–å·¥ä½œåŒºå¤–æ–‡ä»¶
- âš ï¸ **é™åˆ¶**: ä»…æ£€æµ‹ç®€å•çš„é‡å®šå‘ç¬¦å·ï¼Œæ— æ³•é˜²æ­¢é€šè¿‡ç®¡é“ã€å˜é‡ç­‰å¤æ‚æ–¹å¼ç»•è¿‡

#### 3.3 å‘½ä»¤æ‹†åˆ†ä¸éªŒè¯

**æ ¸å¿ƒå‡½æ•°**: `splitCommands(command)`

**ä»£ç ä½ç½®**: [packages/core/src/utils/shell-utils.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/utils/shell-utils.ts)

**å®ç°åŸç†**: ä½¿ç”¨ `web-tree-sitter` è§£æ Shell å‘½ä»¤ï¼Œå°†å¤åˆå‘½ä»¤ï¼ˆå¦‚ `git add . && git commit`ï¼‰æ‹†è§£ä¸ºç‹¬ç«‹çš„å­å‘½ä»¤

**é˜²æŠ¤æ•ˆæœ**:
- âœ… å¯¹æ¯ä¸ªå­å‘½ä»¤ç‹¬ç«‹è¿›è¡Œæƒé™éªŒè¯
- âœ… é˜²æ­¢é€šè¿‡å‘½ä»¤é“¾ç»•è¿‡æƒé™æ£€æŸ¥
- âš ï¸ **é™åˆ¶**: æ— æ³•é˜²æ­¢é€šè¿‡ Shell å˜é‡ã€å‡½æ•°ç­‰åŠ¨æ€æ–¹å¼æ„é€ å±é™©å‘½ä»¤

### 4. å‘½ä»¤æ‰§è¡Œæƒé™æ€»ç»“

| æ¨¡å¼ | å†³ç­– | å¯æ‰§è¡Œå‘½ä»¤ | é‡å®šå‘ | è·¯å¾„é™åˆ¶ | ç”¨æˆ·ç¡®è®¤ |
|-----|-------|----------|--------|---------|---------|
| **Plan** | DENY | æ—  | N/A | N/A | N/A |
| **Default** | ASK_USER | æ‰€æœ‰ï¼ˆéœ€ç¡®è®¤ï¼‰ | âŒ ä¸å…è®¸ | âœ… å·¥ä½œåŒºå†… | âœ… éœ€è¦ |
| **AutoEdit** | ASK_USER | æ‰€æœ‰ï¼ˆéœ€ç¡®è®¤ï¼‰ | âŒ ä¸å…è®¸ | âœ… å·¥ä½œåŒºå†… | âœ… éœ€è¦ |
| **YOLO** | ALLOW | æ‰€æœ‰ï¼ˆæ— éœ€ç¡®è®¤ï¼‰ | âœ… å…è®¸ | âœ… å·¥ä½œåŒºå†… | âŒ ä¸éœ€è¦ |
| **Shell** | ä¾èµ–å½“å‰æ¨¡å¼ | ä¾èµ–å½“å‰æ¨¡å¼ | ä¾èµ–å½“å‰æ¨¡å¼ | âœ… å·¥ä½œåŒºå†… | ä¾èµ–å½“å‰æ¨¡å¼ |

---

## æ–‡ä»¶æ“ä½œæƒé™åˆ†æ

### 1. æ–‡ä»¶æ“ä½œå·¥å…·å®šä¹‰

#### write_file å·¥å…·

**å·¥å…·å‚æ•°**:
```typescript
interface WriteFileToolParams {
  file_path: string;      // æ–‡ä»¶ç»å¯¹è·¯å¾„
  content: string;        // æ–‡ä»¶å†…å®¹
  modified_by_user?: boolean;
  ai_proposed_content?: string;
}
```

**ä»£ç ä½ç½®**: [packages/core/src/tools/write-file.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/tools/write-file.ts#L1-L555)

#### replace å·¥å…·ï¼ˆEdit å·¥å…·ï¼‰

**å·¥å…·å‚æ•°**:
```typescript
interface EditToolParams {
  file_path: string;      // æ–‡ä»¶è·¯å¾„
  old_string: string;     // è¦æ›¿æ¢çš„åŸå§‹æ–‡æœ¬
  new_string: string;     // æ›¿æ¢åçš„æ–°æ–‡æœ¬
  instruction?: string;    // ä¿®æ”¹è¯´æ˜
  expected_replacements?: number; // æœŸæœ›æ›¿æ¢æ¬¡æ•°
}
```

**ä»£ç ä½ç½®**: [packages/core/src/tools/edit.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/tools/edit.ts#L1-L1056)

### 2. äº”å¤§æ¨¡å¼ä¸‹çš„æ–‡ä»¶æ“ä½œæƒé™

#### Default Modeï¼ˆé»˜è®¤æ¨¡å¼ï¼‰

**write_file ç­–ç•¥**: [write.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/write.toml#L54-L56)

```toml
[[rule]]
toolName = "write_file"
decision = "ask_user"
priority = 10
```

**replace ç­–ç•¥**: [write.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/write.toml#L29-L31)

```toml
[[rule]]
toolName = "replace"
decision = "ask_user"
priority = 10
```

**æƒé™è¡¨ç°**:
- **å†³ç­–**: `ASK_USER`ï¼ˆè¯¢é—®ç”¨æˆ·ï¼‰
- **å¯æ“ä½œæ–‡ä»¶**: å·¥ä½œåŒºå†…çš„æ‰€æœ‰æ–‡ä»¶
- **è·¯å¾„é™åˆ¶**: é€šè¿‡ `validatePathAccess` é™åˆ¶åœ¨å·¥ä½œåŒºå†…
- **å®‰å…¨æ£€æŸ¥å™¨**: æ— ï¼ˆæœªé…ç½®ï¼‰

#### AutoEdit Modeï¼ˆè‡ªåŠ¨ç¼–è¾‘æ¨¡å¼ï¼‰

**write_file ç­–ç•¥**: [write.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/write.toml#L60-L67)

```toml
[[rule]]
toolName = "write_file"
decision = "allow"
priority = 15
modes = ["autoEdit"]

[rule.safety_checker]
type = "in-process"
name = "allowed-path"
required_context = ["environment"]
```

**replace ç­–ç•¥**: [write.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/write.toml#L34-L42)

```toml
[[rule]]
toolName = "replace"
decision = "allow"
priority = 15
modes = ["autoEdit"]

[rule.safety_checker]
type = "in-process"
name = "allowed-path"
required_context = ["environment"]
```

**æƒé™è¡¨ç°**:
- **å†³ç­–**: `ALLOW`ï¼ˆè‡ªåŠ¨å…è®¸ï¼‰
- **å¯æ“ä½œæ–‡ä»¶**: å·¥ä½œåŒºå†…çš„æ‰€æœ‰æ–‡ä»¶
- **è·¯å¾„é™åˆ¶**: é€šè¿‡ `validatePathAccess` + `allowed-path` æ£€æŸ¥å™¨åŒé‡ä¿æŠ¤
- **å®‰å…¨æ£€æŸ¥å™¨**: âœ… `allowed-path` æ£€æŸ¥å™¨ç”Ÿæ•ˆ

**å®‰å…¨æ£€æŸ¥å™¨å®ç°**: [packages/core/src/safety/built-in.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/safety/built-in.ts#L21-L154)

```typescript
export class AllowedPathChecker implements InProcessChecker {
  async check(input: SafetyCheckInput): Promise<SafetyCheckResult> {
    const { toolCall, context } = input;
    const config = input.config as AllowedPathConfig | undefined;

    // Build list of allowed directories
    const allowedDirs = [
      context.environment.cwd,
      ...context.environment.workspaces,
    ];

    // Find all arguments that look like paths
    const pathsToCheck = this.collectPathsToCheck(
      toolCall.args,
      includedArgs,
      excludedArgs,
    );

    // Check each path
    for (const { path: p, argName } of pathsToCheck) {
      const resolvedPath = this.safelyResolvePath(p, context.environment.cwd);

      if (!resolvedPath) {
        return {
          decision: SafetyCheckDecision.DENY,
          reason: `Cannot resolve path "${p}" in argument "${argName}"`,
        };
      }

      const isAllowed = allowedDirs.some((dir) => {
        const resolvedDir = this.safelyResolvePath(dir, context.environment.cwd);
        if (!resolvedDir) return false;
        return this.isPathAllowed(resolvedPath, resolvedDir);
      });

      if (!isAllowed) {
        return {
          decision: SafetyCheckDecision.DENY,
          reason: `Path "${p}" in argument "${argName}" is outside of the allowed workspace directories.`,
        };
      }
    }

    return { decision: SafetyCheckDecision.ALLOW };
  }
}
```

#### YOLO Modeï¼ˆè‡ªåŠ¨æ‰¹å‡†æ¨¡å¼ï¼‰

**ç­–ç•¥é…ç½®**: [yolo.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/yolo.toml#L28-L32)

```toml
[[rule]]
decision = "allow"
priority = 999
modes = ["yolo"]
allow_redirection = true
```

**æƒé™è¡¨ç°**:
- **å†³ç­–**: `ALLOW`ï¼ˆè‡ªåŠ¨å…è®¸ï¼‰
- **å¯æ“ä½œæ–‡ä»¶**: å·¥ä½œåŒºå†…çš„æ‰€æœ‰æ–‡ä»¶
- **è·¯å¾„é™åˆ¶**: ä»…é€šè¿‡ `validatePathAccess` é™åˆ¶ï¼ˆå®‰å…¨æ£€æŸ¥å™¨æœªç”Ÿæ•ˆï¼‰
- **å®‰å…¨æ£€æŸ¥å™¨**: âŒ æœªç”Ÿæ•ˆï¼ˆç”±äºä¼˜å…ˆçº§é—®é¢˜ï¼Œè§ä¸‹æ–‡åˆ†æï¼‰

#### Plan Modeï¼ˆè§„åˆ’æ¨¡å¼ï¼‰

**ç­–ç•¥é…ç½®**: [plan.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/write.toml#L71-L75)

```toml
# Allow write_file for .md files in plans directory
[[rule]]
toolName = "write_file"
decision = "allow"
priority = 50
modes = ["plan"]
argsPattern = "\"file_path\":\"[^\"]+/\\.gemini/tmp/[a-f0-9]{64}/plans/[a-zA-Z0-9_-]+\\.md\""
```

**æƒé™è¡¨ç°**:
- **å†³ç­–**: `ALLOW`ï¼ˆè‡ªåŠ¨å…è®¸ï¼‰
- **å¯æ“ä½œæ–‡ä»¶**: ä»…é™ `.gemini/tmp/.../plans/*.md` æ–‡ä»¶
- **è·¯å¾„é™åˆ¶**: é€šè¿‡ `argsPattern` æ­£åˆ™è¡¨è¾¾å¼ä¸¥æ ¼é™åˆ¶
- **å®‰å…¨æ£€æŸ¥å™¨**: æ— ï¼ˆæœªé…ç½®ï¼‰

**argsPattern å®ç°**: é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… JSON åºåˆ—åŒ–åçš„å‚æ•°

**ä»£ç ä½ç½®**: [packages/core/src/policy/policy-engine.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policy-engine.ts#L62-L70)

```typescript
if (
  toolCall.args &&
  (this.rules.some((rule) => rule.argsPattern) ||
    this.checkers.some((checker) => checker.argsPattern))
) {
  stringifiedArgs = stableStringify(toolCall.args);
}
```

### 3. æ–‡ä»¶æ“ä½œé˜²æŠ¤æœºåˆ¶

#### 3.1 è·¯å¾„è®¿é—®æ§åˆ¶

**write_file å·¥å…·**: [packages/core/src/tools/write-file.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/tools/write-file.ts#L251-L262)

```typescript
async execute(abortSignal: AbortSignal): Promise<ToolResult> {
  const validationError = this.config.validatePathAccess(this.resolvedPath);
  if (validationError) {
    return {
      llmContent: validationError,
      returnDisplay: 'Error: Path not in workspace.',
      error: {
        message: validationError,
        type: ToolErrorType.PATH_NOT_IN_WORKSPACE,
      },
    };
  }
  // ... æ‰§è¡Œå†™å…¥æ“ä½œ
}
```

**replace å·¥å…·**: [packages/core/src/tools/edit.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/tools/edit.ts#L760-L771)

```typescript
async execute(signal: AbortSignal): Promise<ToolResult> {
  const resolvedPath = path.resolve(
    this.config.getTargetDir(),
    this.params.file_path,
  );
  const validationError = this.config.validatePathAccess(resolvedPath);
  if (validationError) {
    return {
      llmContent: validationError,
      returnDisplay: 'Error: Path not in workspace.',
      error: {
        message: validationError,
        type: ToolErrorType.PATH_NOT_IN_WORKSPACE,
      },
    };
  }
  // ... æ‰§è¡Œç¼–è¾‘æ“ä½œ
}
```

#### 3.2 å®‰å…¨æ£€æŸ¥å™¨æœºåˆ¶

**æ£€æŸ¥å™¨æ³¨å†Œ**: [packages/core/src/safety/registry.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/safety/registry.ts#L40-L45)

```typescript
private static readonly BUILT_IN_IN_PROCESS_CHECKERS = new Map<
  string,
  InProcessChecker
>([[InProcessCheckerType.ALLOWED_PATH, new AllowedPathChecker()]]);
```

**æ£€æŸ¥å™¨æ‰§è¡Œ**: [packages/core/src/policy/policy-engine.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policy-engine.ts#L393-L424)

```typescript
if (decision !== PolicyDecision.DENY && this.checkerRunner) {
  for (const checkerRule of this.checkers) {
    if (
      ruleMatches(
        checkerRule,
        toolCall,
        stringifiedArgs,
        serverName,
        this.approvalMode,
      )
    ) {
      debugLogger.debug(
        `[PolicyEngine.check] Running safety checker: ${checkerRule.checker.name}`,
      );
      try {
        const result = await this.checkerRunner.runChecker(
          toolCall,
          checkerRule.checker,
        );
        if (result.decision === SafetyCheckDecision.DENY) {
          debugLogger.debug(
            `[PolicyEngine.check] Safety checker '${checkerRule.checker.name}' denied execution: ${result.reason}`,
          );
          return {
            decision: PolicyDecision.DENY,
            rule: matchedRule,
          };
        } else if (result.decision === SafetyCheckDecision.ASK_USER) {
          debugLogger.debug(
            `[PolicyEngine.check] Safety checker requested ASK_USER: ${result.reason}`,
          );
          decision = PolicyDecision.ASK_USER;
        }
      } catch (error) {
        debugLogger.debug(
          `[PolicyEngine.check] Safety checker '${checkerRule.checker.name}' threw an error:`,
          error,
        );
        return {
          decision: PolicyDecision.DENY,
          rule: matchedRule,
        };
      }
    }
  }
}
```

**æ³¨æ„**: å®‰å…¨æ£€æŸ¥å™¨åªåœ¨å†³ç­–ä¸º `ALLOW` æˆ– `ASK_USER` æ—¶æ‰§è¡Œï¼Œå¦‚æœå†³ç­–å·²ç»æ˜¯ `DENY`ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œæ£€æŸ¥å™¨ã€‚

### 4. æ–‡ä»¶æ“ä½œæƒé™æ€»ç»“

| æ¨¡å¼ | write_file | replace | è·¯å¾„é™åˆ¶ | å®‰å…¨æ£€æŸ¥å™¨ | ç”¨æˆ·ç¡®è®¤ |
|-----|-----------|---------|---------|-----------|---------|
| **Plan** | âš ï¸ ä»…é™ plans ç›®å½• | âŒ DENY | âœ… argsPattern | âŒ | âŒ |
| **Default** | ğŸ‘¤ ASK_USER | ğŸ‘¤ ASK_USER | âœ… validatePathAccess | âŒ | âœ… |
| **AutoEdit** | âœ… ALLOW | âœ… ALLOW | âœ… åŒé‡ä¿æŠ¤ | âœ… | âŒ |
| **YOLO** | âœ… ALLOW | âœ… ALLOW | âš ï¸ ä»… validatePathAccess | âŒ | âŒ |
| **Shell** | ä¾èµ–å½“å‰æ¨¡å¼ | ä¾èµ–å½“å‰æ¨¡å¼ | âœ… validatePathAccess | ä¾èµ–å½“å‰æ¨¡å¼ | ä¾èµ–å½“å‰æ¨¡å¼ |

---

## é»‘ç™½åå•æœºåˆ¶

### 1. å·¥å…·çº§é»‘ç™½åå•

#### 1.1 ç™½åå•æœºåˆ¶

**é…ç½®æ–¹å¼**:
- **å‘½ä»¤è¡Œå‚æ•°**: `--allowed-tools=tool1,tool2`
- **è®¾ç½®æ–‡ä»¶**: `settings.json` ä¸­çš„ `tools.allowed`

**ä»£ç ä½ç½®**: [packages/cli/src/config/config.ts](file:///d:/Code_AI/gemini-cli/packages/cli/src/config/config.ts#L592-L593)

```typescript
const allowedTools = argv.allowedTools || settings.tools?.allowed || [];
const allowedToolsSet = new Set(allowedTools);
```

**è¿‡æ»¤å‡½æ•°**: [packages/cli/src/config/config.ts](file:///d:/Code_AI/gemini-cli/packages/cli/src/config/config.ts#L376-L397)

```typescript
function createToolExclusionFilter(
  allowedTools: string[],
  allowedToolsSet: Set<string>,
) {
  return (tool: string): boolean => {
    if (tool === SHELL_TOOL_NAME) {
      // If any of the allowed tools is ShellTool (even with subcommands), don't exclude it.
      return !allowedTools.some((allowed) =>
        SHELL_TOOL_NAMES.some((shellName) => allowed.startsWith(shellName)),
      );
    }
    return !allowedToolsSet.has(tool);
  };
}
```

**ä½¿ç”¨åœºæ™¯**:
```bash
# åªå…è®¸è¯»å–å’Œæœç´¢å·¥å…·
gemini --allowed-tools=read_file,list_directory,search_file_content

# å…è®¸ç‰¹å®šçš„ Shell å‘½ä»¤
gemini --allowed-tools="ShellTool(git status),ShellTool(git log)"
```

#### 1.2 é»‘åå•æœºåˆ¶

**é…ç½®æ–¹å¼**:
- **è®¾ç½®æ–‡ä»¶**: `settings.json` ä¸­çš„ `tools.exclude`
- **æ‰©å±•é…ç½®**: æ‰©å±•çš„ `excludeTools` å­—æ®µ

**ä»£ç ä½ç½®**: [packages/cli/src/config/config.ts](file:///d:/Code_AI/gemini-cli/packages/cli/src/config/config.ts#L634-L642)

```typescript
const excludeTools = mergeExcludeTools(settings, extraExcludes);

// Create a settings object that includes CLI overrides for policy generation
const effectiveSettings: Settings = {
  ...settings,
  tools: {
    ...settings.tools,
    allowed: allowedTools,
    exclude: excludeTools,
  },
};
```

**åˆå¹¶å‡½æ•°**: [packages/cli/src/config/config.ts](file:///d:/Code_AI/gemini-cli/packages/cli/src/config/config.ts#L1-L50)

```typescript
export function mergeExcludeTools(
  settings: MergedSettings,
  extraExcludes: string[],
): string[] {
  const baseExcludes = settings.tools?.exclude || [];
  const extensionExcludes = settings.extensions
    ?.flatMap((ext) => ext.excludeTools || []);

  return [...new Set([...baseExcludes, ...extensionExcludes, ...extraExcludes])];
}
```

**ä½¿ç”¨åœºæ™¯**:
```json
{
  "tools": {
    "exclude": ["run_shell_command", "web_fetch"]
  }
}
```

### 2. å‘½ä»¤çº§é»‘ç™½åå•

#### 2.1 å‘½ä»¤å‰ç¼€åŒ¹é…ï¼ˆcommandPrefixï¼‰

**é…ç½®æ–¹å¼**: åœ¨ TOML ç­–ç•¥æ–‡ä»¶ä¸­ä½¿ç”¨ `commandPrefix`

**ä»£ç ä½ç½®**: [packages/core/src/policy/toml-loader.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/toml-loader.ts#L30-L49)

```toml
[[rule]]
toolName = "run_shell_command"
commandPrefix = "git"
decision = "allow"
priority = 20
```

**å®ç°åŸç†**: `commandPrefix` ä¼šè¢«è½¬æ¢ä¸º `argsPattern` æ­£åˆ™è¡¨è¾¾å¼

**è½¬æ¢å‡½æ•°**: [packages/core/src/policy/utils.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/utils.ts#L18-L52)

```typescript
export function buildArgsPatterns(
  argsPattern?: string,
  commandPrefix?: string | string[],
  commandRegex?: string,
): RegExp[] {
  if (commandPrefix) {
    const prefixes = Array.isArray(commandPrefix)
      ? commandPrefix
      : [commandPrefix];
    return prefixes.map((prefix) => {
      const escaped = escapeRegex(prefix);
      return new RegExp(`"command":"${escaped}\\s+`);
    });
  }

  if (commandRegex) {
    return [new RegExp(`"command":"${commandRegex}`)];
  }

  return [argsPattern];
}
```

**ç¤ºä¾‹**:
```toml
# å…è®¸ git status å’Œ git log
[[rule]]
toolName = "run_shell_command"
commandPrefix = ["git status", "git log"]
decision = "allow"
priority = 20
```

#### 2.2 å‘½ä»¤æ­£åˆ™åŒ¹é…ï¼ˆcommandRegexï¼‰

**é…ç½®æ–¹å¼**: åœ¨ TOML ç­–ç•¥æ–‡ä»¶ä¸­ä½¿ç”¨ `commandRegex`

**ä»£ç ä½ç½®**: [packages/core/src/policy/toml-loader.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/toml-loader.ts#L48-L52)

```toml
[[rule]]
toolName = "run_shell_command"
commandRegex = "^(git|ls)\\s+.*"
decision = "allow"
priority = 20
```

**å®ç°åŸç†**: ç›´æ¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å‘½ä»¤

**ç¤ºä¾‹**:
```toml
# ç¦æ­¢ rm å‘½ä»¤
[[rule]]
toolName = "run_shell_command"
commandRegex = "^rm\\s+.*"
decision = "deny"
priority = 999
deny_message = "Deleting files via shell is not allowed."
```

#### 2.3 å‚æ•°æ¨¡å¼åŒ¹é…ï¼ˆargsPatternï¼‰

**é…ç½®æ–¹å¼**: åœ¨ TOML ç­–ç•¥æ–‡ä»¶ä¸­ä½¿ç”¨ `argsPattern`

**ä»£ç ä½ç½®**: [packages/core/src/policy/toml-loader.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/toml-loader.ts#L27)

```toml
[[rule]]
toolName = "write_file"
decision = "allow"
priority = 50
modes = ["plan"]
argsPattern = "\"file_path\":\"[^\"]+/\\.gemini/tmp/[a-f0-9]{64}/plans/[a-zA-Z0-9_-]+\\.md\""
```

**å®ç°åŸç†**: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… JSON åºåˆ—åŒ–åçš„å‚æ•°

**ç¤ºä¾‹**:
```toml
# ç¦æ­¢åˆ é™¤ .git ç›®å½•
[[rule]]
toolName = "run_shell_command"
argsPattern = "\"command\":\"rm\\s+.*\\.git.*\""
decision = "deny"
priority = 999
```

### 3. é»‘ç™½åå•è¯†åˆ«ç‰¹å®šå‘½ä»¤çš„æ–¹å¼

#### 3.1 å±é™©å‘½ä»¤é»‘åå•ç¤ºä¾‹

**ç¦æ­¢ rm å‘½ä»¤**:

```toml
# æ–¹å¼ 1: ä½¿ç”¨ commandRegex
[[rule]]
toolName = "run_shell_command"
commandRegex = "^rm\\s+.*"
decision = "deny"
priority = 999
deny_message = "The rm command is not allowed."
```

**ç¦æ­¢ sudo å‘½ä»¤**:

```toml
[[rule]]
toolName = "run_shell_command"
commandRegex = "^sudo\\s+.*"
decision = "deny"
priority = 999
deny_message = "The sudo command is not allowed."
```

**ç¦æ­¢å¤šä¸ªå±é™©å‘½ä»¤**:

```toml
[[rule]]
toolName = "run_shell_command"
commandRegex = "^(rm|sudo|dd|mkfs)\\s+.*"
decision = "deny"
priority = 999
deny_message = "Dangerous commands are not allowed."
```

#### 3.2 å®‰å…¨å‘½ä»¤ç™½åå•ç¤ºä¾‹

**åªå…è®¸ git å’Œ ls å‘½ä»¤**:

```toml
# æ–¹å¼ 1: ä½¿ç”¨ commandPrefix
[[rule]]
toolName = "run_shell_command"
commandPrefix = ["git", "ls"]
decision = "allow"
priority = 20

# æ–¹å¼ 2: ä½¿ç”¨ commandRegex
[[rule]]
toolName = "run_shell_command"
commandRegex = "^(git|ls)\\s+.*"
decision = "allow"
priority = 20
```

**åªå…è®¸ git çš„åªè¯»å‘½ä»¤**:

```toml
[[rule]]
toolName = "run_shell_command"
commandPrefix = ["git status", "git log", "git diff", "git show"]
decision = "allow"
priority = 20

[[rule]]
toolName = "run_shell_command"
commandPrefix = "git"
decision = "deny"
priority = 10
```

### 4. é»‘ç™½åå•é…ç½®æ–¹å¼æ€»ç»“

| é…ç½®æ–¹å¼ | é…ç½®ä½ç½® | ä½œç”¨èŒƒå›´ | ä¼˜å…ˆçº§ | ç¤ºä¾‹ |
|---------|---------|---------|--------|------|
| **--allowed-tools** | å‘½ä»¤è¡Œ | å·¥å…·çº§ç™½åå• | 2.3 | `--allowed-tools=read_file,write_file` |
| **tools.exclude** | settings.json | å·¥å…·çº§é»‘åå• | 2.4 | `{"tools": {"exclude": ["run_shell_command"]}}` |
| **commandPrefix** | TOML ç­–ç•¥æ–‡ä»¶ | å‘½ä»¤å‰ç¼€ç™½åå• | 1.x | `commandPrefix = "git"` |
| **commandRegex** | TOML ç­–ç•¥æ–‡ä»¶ | å‘½ä»¤æ­£åˆ™åŒ¹é… | 1.x | `commandRegex = "^(git|ls)\\s+.*"` |
| **argsPattern** | TOML ç­–ç•¥æ–‡ä»¶ | å‚æ•°æ¨¡å¼åŒ¹é… | 1.x | `argsPattern = "\"command\":\"rm\\s+.*\""` |

**ä¼˜å…ˆçº§è¯´æ˜**:
- **Tier 1 (Default)**: 1.000 - 1.999 - ç³»ç»Ÿé»˜è®¤ç­–ç•¥
- **Tier 2 (User)**: 2.000 - 2.999 - ç”¨æˆ·é…ç½®ç­–ç•¥
- **Tier 3 (Admin)**: 3.000 - 3.999 - ç®¡ç†å‘˜ç­–ç•¥

---

## å®‰å…¨æ£€æŸ¥å™¨æœºåˆ¶

### 1. å®‰å…¨æ£€æŸ¥å™¨ç±»å‹

#### 1.1 In-Process æ£€æŸ¥å™¨ï¼ˆè¿›ç¨‹å†…æ£€æŸ¥å™¨ï¼‰

**å®šä¹‰**: åœ¨åŒä¸€è¿›ç¨‹ä¸­æ‰§è¡Œçš„æ£€æŸ¥å™¨ï¼Œæ— éœ€å¯åŠ¨å¤–éƒ¨è¿›ç¨‹

**æ¥å£å®šä¹‰**: [packages/core/src/safety/built-in.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/safety/built-in.ts#L14-L19)

```typescript
export interface InProcessChecker {
  check(input: SafetyCheckInput): Promise<SafetyCheckResult>;
}
```

**å†…ç½®æ£€æŸ¥å™¨**: [packages/core/src/safety/registry.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/safety/registry.ts#L40-L45)

```typescript
private static readonly BUILT_IN_IN_PROCESS_CHECKERS = new Map<
  string,
  InProcessChecker
>([[InProcessCheckerType.ALLOWED_PATH, new AllowedPathChecker()]]);
```

**ç±»å‹æšä¸¾**: [packages/core/src/policy/types.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/types.ts#L91-L93)

```typescript
export enum InProcessCheckerType {
  ALLOWED_PATH = 'allowed-path',
}
```

#### 1.2 External æ£€æŸ¥å™¨ï¼ˆå¤–éƒ¨æ£€æŸ¥å™¨ï¼‰

**å®šä¹‰**: ä½œä¸ºç‹¬ç«‹è¿›ç¨‹æ‰§è¡Œçš„æ£€æŸ¥å™¨ï¼Œé€šè¿‡æ ‡å‡†è¾“å…¥/è¾“å‡ºé€šä¿¡

**æ¥å£å®šä¹‰**: [packages/core/src/safety/checker-runner.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/safety/checker-runner.ts#L145-L245)

**æ‰§è¡Œæµç¨‹**:
```
PolicyEngine â†’ CheckerRunner â†’ spawn(checker_path) â†’ stdin(input) â†’ stdout(result)
```

**æ³¨æ„**: å½“å‰ç‰ˆæœ¬æœªå®ç°å¤–éƒ¨æ£€æŸ¥å™¨ï¼Œé¢„ç•™æ¥å£ã€‚

### 2. AllowedPathChecker å®ç°åˆ†æ

#### 2.1 æ£€æŸ¥å™¨åŠŸèƒ½

**åŠŸèƒ½**: éªŒè¯å·¥å…·è°ƒç”¨ä¸­çš„è·¯å¾„å‚æ•°æ˜¯å¦åœ¨å…è®¸çš„å·¥ä½œç›®å½•èŒƒå›´å†…

**ä»£ç ä½ç½®**: [packages/core/src/safety/built-in.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/safety/built-in.ts#L21-L154)

#### 2.2 æ£€æŸ¥æµç¨‹

**æ­¥éª¤ 1: æ„å»ºå…è®¸ç›®å½•åˆ—è¡¨**

```typescript
const allowedDirs = [
  context.environment.cwd,
  ...context.environment.workspaces,
];
```

**æ­¥éª¤ 2: æ”¶é›†éœ€è¦æ£€æŸ¥çš„è·¯å¾„**

```typescript
const pathsToCheck = this.collectPathsToCheck(
  toolCall.args,
  includedArgs,
  excludedArgs,
);
```

**è·¯å¾„æ”¶é›†è§„åˆ™**:
- è‡ªåŠ¨è¯†åˆ«åŒ…å« `path`ã€`directory`ã€`file`ã€`source`ã€`destination` ç­‰å…³é”®è¯çš„å‚æ•°
- æ”¯æŒé€šè¿‡ `included_args` æ˜¾å¼æŒ‡å®šè¦æ£€æŸ¥çš„å‚æ•°
- æ”¯æŒé€šè¿‡ `excluded_args` æ’é™¤ä¸éœ€è¦æ£€æŸ¥çš„å‚æ•°

**æ­¥éª¤ 3: è§£æå¹¶éªŒè¯æ¯ä¸ªè·¯å¾„**

```typescript
for (const { path: p, argName } of pathsToCheck) {
  const resolvedPath = this.safelyResolvePath(p, context.environment.cwd);

  if (!resolvedPath) {
    return {
      decision: SafetyCheckDecision.DENY,
      reason: `Cannot resolve path "${p}" in argument "${argName}"`,
    };
  }

  const isAllowed = allowedDirs.some((dir) => {
    const resolvedDir = this.safelyResolvePath(dir, context.environment.cwd);
    if (!resolvedDir) return false;
    return this.isPathAllowed(resolvedPath, resolvedDir);
  });

  if (!isAllowed) {
    return {
      decision: SafetyCheckDecision.DENY,
      reason: `Path "${p}" in argument "${argName}" is outside of the allowed workspace directories.`,
    };
  }
}
```

**æ­¥éª¤ 4: è·¯å¾„è§£æä¸ç¬¦å·é“¾æ¥å¤„ç†**

```typescript
private safelyResolvePath(inputPath: string, cwd: string): string | null {
  try {
    const resolved = path.resolve(cwd, inputPath);

    // Walk up the directory tree until we find a path that exists
    let current = resolved;
    while (current && current !== path.dirname(current)) {
      if (fs.existsSync(current)) {
        const canonical = fs.realpathSync(current);
        const relative = path.relative(current, resolved);
        return path.join(canonical, relative);
      }
      current = path.dirname(current);
    }

    return resolved;
  } catch (_error) {
    return null;
  }
}
```

**æ­¥éª¤ 5: è·¯å¾„å…è®¸æ£€æŸ¥**

```typescript
private isPathAllowed(targetPath: string, allowedDir: string): boolean {
  const relative = path.relative(allowedDir, targetPath);
  return (
    relative === '' ||
    (!relative.startsWith('..') && !path.isAbsolute(relative))
  );
}
```

#### 2.3 æ£€æŸ¥å™¨é…ç½®

**é…ç½®ç¤ºä¾‹**: [write.toml](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policies/write.toml#L60-L67)

```toml
[[rule]]
toolName = "write_file"
decision = "allow"
priority = 15
modes = ["autoEdit"]

[rule.safety_checker]
type = "in-process"
name = "allowed-path"
required_context = ["environment"]
```

**é…ç½®å‚æ•°**:
- `type`: æ£€æŸ¥å™¨ç±»å‹ï¼ˆ`in-process` æˆ– `external`ï¼‰
- `name`: æ£€æŸ¥å™¨åç§°ï¼ˆ`allowed-path`ï¼‰
- `required_context`: éœ€è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆ`environment`ï¼‰
- `config`: æ£€æŸ¥å™¨é…ç½®ï¼ˆå¯é€‰ï¼‰

### 3. å®‰å…¨æ£€æŸ¥å™¨æ‰§è¡Œæ—¶æœº

**æ‰§è¡Œæ¡ä»¶**: [packages/core/src/policy/policy-engine.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policy-engine.ts#L393-L424)

```typescript
if (decision !== PolicyDecision.DENY && this.checkerRunner) {
  for (const checkerRule of this.checkers) {
    if (
      ruleMatches(
        checkerRule,
        toolCall,
        stringifiedArgs,
        serverName,
        this.approvalMode,
      )
    ) {
      // æ‰§è¡Œæ£€æŸ¥å™¨
    }
  }
}
```

**æ‰§è¡Œæ¡ä»¶**:
1. ç­–ç•¥å†³ç­–ä¸æ˜¯ `DENY`
2. å­˜åœ¨ `checkerRunner`
3. æ£€æŸ¥å™¨è§„åˆ™åŒ¹é…å½“å‰å·¥å…·è°ƒç”¨

**æ‰§è¡Œé¡ºåº**:
1. ç­–ç•¥è§„åˆ™åŒ¹é… â†’ 2. ç­–ç•¥å†³ç­– â†’ 3. å®‰å…¨æ£€æŸ¥å™¨æ‰§è¡Œ â†’ 4. æœ€ç»ˆå†³ç­–

### 4. å®‰å…¨æ£€æŸ¥å™¨ç»“æœå¤„ç†

**ALLOW ç»“æœ**: ä¿æŒåŸç­–ç•¥å†³ç­–

**DENY ç»“æœ**: è¦†ç›–ä¸º `DENY`ï¼Œæ‹’ç»æ“ä½œ

**ASK_USER ç»“æœ**: é™çº§ä¸º `ASK_USER`ï¼Œéœ€è¦ç”¨æˆ·ç¡®è®¤

**é”™è¯¯ç»“æœ**: è¦†ç›–ä¸º `DENY`ï¼Œæ‹’ç»æ“ä½œ

**ä»£ç ä½ç½®**: [packages/core/src/policy/policy-engine.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policy-engine.ts#L405-L422)

```typescript
const result = await this.checkerRunner.runChecker(
  toolCall,
  checkerRule.checker,
);
if (result.decision === SafetyCheckDecision.DENY) {
  debugLogger.debug(
    `[PolicyEngine.check] Safety checker '${checkerRule.checker.name}' denied execution: ${result.reason}`,
  );
  return {
    decision: PolicyDecision.DENY,
    rule: matchedRule,
  };
} else if (result.decision === SafetyCheckDecision.ASK_USER) {
  debugLogger.debug(
    `[PolicyEngine.check] Safety checker requested ASK_USER: ${result.reason}`,
  );
  decision = PolicyDecision.ASK_USER;
}
```

---

## è·¨æ¨¡å¼æƒé™å¯¹æ¯”è¡¨

### 1. å‘½ä»¤æ‰§è¡Œæƒé™å¯¹æ¯”

| ç»´åº¦ | Plan Mode | Default Mode | AutoEdit Mode | YOLO Mode | Shell Mode |
|-----|-----------|--------------|---------------|-----------|-----------|
| **run_shell_command å†³ç­–** | DENY | ASK_USER | ASK_USER | ALLOW | ä¾èµ–å½“å‰æ¨¡å¼ |
| **å¯æ‰§è¡Œå‘½ä»¤** | æ—  | æ‰€æœ‰ï¼ˆéœ€ç¡®è®¤ï¼‰ | æ‰€æœ‰ï¼ˆéœ€ç¡®è®¤ï¼‰ | æ‰€æœ‰ï¼ˆæ— éœ€ç¡®è®¤ï¼‰ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **å‘½ä»¤é‡å®šå‘** | N/A | âŒ ä¸å…è®¸ | âŒ ä¸å…è®¸ | âœ… å…è®¸ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **è·¯å¾„é™åˆ¶** | N/A | âœ… å·¥ä½œåŒºå†… | âœ… å·¥ä½œåŒºå†… | âœ… å·¥ä½œåŒºå†… | âœ… å·¥ä½œåŒºå†… |
| **ç”¨æˆ·ç¡®è®¤** | N/A | âœ… éœ€è¦ | âœ… éœ€è¦ | âŒ ä¸éœ€è¦ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **é»‘ç™½åå•** | N/A | âœ… ç”Ÿæ•ˆ | âœ… ç”Ÿæ•ˆ | âœ… ç”Ÿæ•ˆ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **å®‰å…¨æ£€æŸ¥å™¨** | N/A | âŒ æœªé…ç½® | âŒ æœªé…ç½® | âŒ æœªé…ç½® | ä¾èµ–å½“å‰æ¨¡å¼ |

### 2. æ–‡ä»¶æ“ä½œæƒé™å¯¹æ¯”

| ç»´åº¦ | Plan Mode | Default Mode | AutoEdit Mode | YOLO Mode | Shell Mode |
|-----|-----------|--------------|---------------|-----------|-----------|
| **write_file å†³ç­–** | âš ï¸ é™åˆ¶å…è®¸ | ASK_USER | ALLOW | ALLOW | ä¾èµ–å½“å‰æ¨¡å¼ |
| **replace å†³ç­–** | âŒ DENY | ASK_USER | ALLOW | ALLOW | ä¾èµ–å½“å‰æ¨¡å¼ |
| **å¯æ“ä½œæ–‡ä»¶èŒƒå›´** | ä»…é™ plans ç›®å½• | å·¥ä½œåŒºå†…æ‰€æœ‰ | å·¥ä½œåŒºå†…æ‰€æœ‰ | å·¥ä½œåŒºå†…æ‰€æœ‰ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **è·¯å¾„é™åˆ¶** | âœ… argsPattern | âœ… validatePathAccess | âœ… åŒé‡ä¿æŠ¤ | âš ï¸ ä»… validatePathAccess | ä¾èµ–å½“å‰æ¨¡å¼ |
| **å®‰å…¨æ£€æŸ¥å™¨** | âŒ æœªé…ç½® | âŒ æœªé…ç½® | âœ… allowed-path | âŒ æœªç”Ÿæ•ˆ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **ç”¨æˆ·ç¡®è®¤** | âŒ ä¸éœ€è¦ | âœ… éœ€è¦ | âŒ ä¸éœ€è¦ | âŒ ä¸éœ€è¦ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **é»‘ç™½åå•** | âœ… ç”Ÿæ•ˆ | âœ… ç”Ÿæ•ˆ | âœ… ç”Ÿæ•ˆ | âœ… ç”Ÿæ•ˆ | ä¾èµ–å½“å‰æ¨¡å¼ |

### 3. ç³»ç»Ÿçº§æ–‡ä»¶è®¿é—®é˜²æŠ¤

| ç»´åº¦ | Plan Mode | Default Mode | AutoEdit Mode | YOLO Mode | Shell Mode |
|-----|-----------|--------------|---------------|-----------|-----------|
| **å·¥ä½œåŒºå¤–æ–‡ä»¶è®¿é—®** | âŒ å®Œå…¨ç¦æ­¢ | âŒ validatePathAccess | âŒ åŒé‡ä¿æŠ¤ | âš ï¸ ä»… validatePathAccess | ä¾èµ–å½“å‰æ¨¡å¼ |
| **ç³»ç»Ÿç®¡ç†å‘˜æ–‡ä»¶è®¿é—®** | âŒ å®Œå…¨ç¦æ­¢ | âŒ validatePathAccess | âŒ åŒé‡ä¿æŠ¤ | âš ï¸ ä»… validatePathAccess | ä¾èµ–å½“å‰æ¨¡å¼ |
| **è·¯å¾„éå†æ”»å‡»é˜²æŠ¤** | âœ… å®Œå…¨é˜²æŠ¤ | âœ… validatePathAccess | âœ… åŒé‡ä¿æŠ¤ | âš ï¸ ä»… validatePathAccess | ä¾èµ–å½“å‰æ¨¡å¼ |
| **ç¬¦å·é“¾æ¥é˜²æŠ¤** | âœ… å®Œå…¨é˜²æŠ¤ | âœ… realpath è§£æ | âœ… realpath è§£æ | âš ï¸ ä»… realpath è§£æ | ä¾èµ–å½“å‰æ¨¡å¼ |

### 4. é€šè¿‡å‘½ä»¤æ‰§è¡Œé—´æ¥è®¿é—®æ–‡ä»¶

| æ”»å‡»æ–¹å¼ | Plan Mode | Default Mode | AutoEdit Mode | YOLO Mode | Shell Mode |
|---------|-----------|--------------|---------------|-----------|-----------|
| **é€šè¿‡ rm åˆ é™¤å·¥ä½œåŒºå¤–æ–‡ä»¶** | âŒ å®Œå…¨ç¦æ­¢ | âš ï¸ validatePathAccess é™åˆ¶ | âš ï¸ validatePathAccess é™åˆ¶ | âš ï¸ validatePathAccess é™åˆ¶ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **é€šè¿‡ cat è¯»å–ç³»ç»Ÿæ–‡ä»¶** | âŒ å®Œå…¨ç¦æ­¢ | âš ï¸ validatePathAccess é™åˆ¶ | âš ï¸ validatePathAccess é™åˆ¶ | âš ï¸ validatePathAccess é™åˆ¶ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **é€šè¿‡é‡å®šå‘å†™å…¥å·¥ä½œåŒºå¤–** | âŒ å®Œå…¨ç¦æ­¢ | âœ… é‡å®šå‘æ£€æµ‹ | âœ… é‡å®šå‘æ£€æµ‹ | âŒ å…è®¸é‡å®šå‘ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **é€šè¿‡ç®¡é“ç»•è¿‡è·¯å¾„æ£€æŸ¥** | âŒ å®Œå…¨ç¦æ­¢ | âš ï¸ éƒ¨åˆ†é˜²æŠ¤ | âš ï¸ éƒ¨åˆ†é˜²æŠ¤ | âŒ æ— é˜²æŠ¤ | ä¾èµ–å½“å‰æ¨¡å¼ |
| **é€šè¿‡å˜é‡æ„é€ å±é™©å‘½ä»¤** | âŒ å®Œå…¨ç¦æ­¢ | âš ï¸ éƒ¨åˆ†é˜²æŠ¤ | âš ï¸ éƒ¨åˆ†é˜²æŠ¤ | âŒ æ— é˜²æŠ¤ | ä¾èµ–å½“å‰æ¨¡å¼ |

---

## å®‰å…¨é˜²æŠ¤ç­–ç•¥æ€»ç»“

### 1. çºµæ·±é˜²å¾¡ä½“ç³»

Gemini CLI é‡‡ç”¨å¤šå±‚å®‰å…¨é˜²æŠ¤æœºåˆ¶ï¼š

```
ç¬¬ 1 å±‚: å·¥å…·çº§é»‘ç™½åå•ï¼ˆ--allowed-tools, tools.excludeï¼‰
    â†“
ç¬¬ 2 å±‚: ç­–ç•¥è§„åˆ™åŒ¹é…ï¼ˆtoolName, modes, priorityï¼‰
    â†“
ç¬¬ 3 å±‚: å‘½ä»¤çº§é»‘ç™½åå•ï¼ˆcommandPrefix, commandRegex, argsPatternï¼‰
    â†“
ç¬¬ 4 å±‚: è·¯å¾„è®¿é—®æ§åˆ¶ï¼ˆvalidatePathAccessï¼‰
    â†“
ç¬¬ 5 å±‚: å®‰å…¨æ£€æŸ¥å™¨ï¼ˆallowed-path checkerï¼‰
    â†“
ç¬¬ 6 å±‚: ç”¨æˆ·ç¡®è®¤ï¼ˆASK_USERï¼‰
```

### 2. å„æ¨¡å¼å®‰å…¨çº§åˆ«è¯„ä¼°

| æ¨¡å¼ | å®‰å…¨çº§åˆ« | é˜²æŠ¤å±‚çº§ | é€‚ç”¨åœºæ™¯ |
|-----|---------|---------|---------|
| **Plan Mode** | æœ€é«˜ | 6 å±‚ï¼ˆå®Œæ•´é˜²æŠ¤ï¼‰ | åªè¯»è§„åˆ’ã€ä»£ç å®¡æŸ¥ |
| **Default Mode** | é«˜ | 5 å±‚ï¼ˆæ— å®‰å…¨æ£€æŸ¥å™¨ï¼‰ | æ—¥å¸¸å¼€å‘ã€äººæœºåä½œ |
| **AutoEdit Mode** | ä¸­é«˜ | 6 å±‚ï¼ˆå®Œæ•´é˜²æŠ¤ï¼‰ | è‡ªåŠ¨ç¼–è¾‘ã€æ‰¹é‡ä¿®æ”¹ |
| **YOLO Mode** | ä½ | 4 å±‚ï¼ˆæ— å®‰å…¨æ£€æŸ¥å™¨ã€æ— ç”¨æˆ·ç¡®è®¤ï¼‰ | CI/CDã€è‡ªåŠ¨åŒ–è„šæœ¬ |
| **Shell Mode** | ä¾èµ–å½“å‰æ¨¡å¼ | ä¾èµ–å½“å‰æ¨¡å¼ | äº¤äº’å¼ Shell æ“ä½œ |

### 3. å…³é”®å®‰å…¨æœºåˆ¶ä»£ç ä½ç½®

| æœºåˆ¶ | æ–‡ä»¶ä½ç½® | è¡Œå· |
|-----|---------|------|
| **è·¯å¾„è®¿é—®æ§åˆ¶** | [packages/core/src/utils/paths.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/utils/paths.ts#L335-L350) | 335-350 |
| **è·¯å¾„éªŒè¯** | [packages/core/src/tools/shell.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/tools/shell.ts#L186-L194) | 186-194 |
| **é‡å®šå‘æ£€æµ‹** | [packages/core/src/policy/policy-engine.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policy-engine.ts#L140-L147) | 140-147 |
| **å‘½ä»¤æ‹†åˆ†** | [packages/core/src/utils/shell-utils.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/utils/shell-utils.ts) | å…¨æ–‡ |
| **å®‰å…¨æ£€æŸ¥å™¨** | [packages/core/src/safety/built-in.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/safety/built-in.ts#L21-L154) | 21-154 |
| **æ£€æŸ¥å™¨æ³¨å†Œ** | [packages/core/src/safety/registry.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/safety/registry.ts#L40-L45) | 40-45 |
| **æ£€æŸ¥å™¨æ‰§è¡Œ** | [packages/core/src/policy/policy-engine.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/policy-engine.ts#L393-L424) | 393-424 |
| **é»‘ç™½åå•** | [packages/cli/src/config/config.ts](file:///d:/Code_AI/gemini-cli/packages/cli/src/config/config.ts#L376-L397) | 376-397 |
| **å‘½ä»¤å‰ç¼€** | [packages/core/src/policy/utils.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/utils.ts#L18-L52) | 18-52 |
| **TOML åŠ è½½** | [packages/core/src/policy/toml-loader.ts](file:///d:/Code_AI/gemini-cli/packages/core/src/policy/toml-loader.ts) | å…¨æ–‡ |

### 4. å®‰å…¨å»ºè®®

#### 4.1 ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **ä½¿ç”¨ Default Mode**: ä¿æŒæœ€å°æƒé™åŸåˆ™ï¼Œæ‰€æœ‰æ“ä½œéœ€è¦ç”¨æˆ·ç¡®è®¤
2. **é…ç½®é»‘ç™½åå•**: æ˜ç¡®å…è®¸çš„å·¥å…·å’Œå‘½ä»¤ï¼Œç¦æ­¢å±é™©å‘½ä»¤
3. **å¯ç”¨å®‰å…¨æ£€æŸ¥å™¨**: åœ¨ AutoEdit æ¨¡å¼ä¸‹ç¡®ä¿ `allowed-path` æ£€æŸ¥å™¨ç”Ÿæ•ˆ
4. **é™åˆ¶å·¥ä½œåŒº**: ç¡®ä¿ `validatePathAccess` æ­£ç¡®é…ç½®ï¼Œé˜²æ­¢è¶Šç•Œè®¿é—®

#### 4.2 è‡ªåŠ¨åŒ–ç¯å¢ƒå»ºè®®

1. **è°¨æ…ä½¿ç”¨ YOLO Mode**: ä»…åœ¨å¯ä¿¡çš„ CI/CD ç¯å¢ƒä¸­ä½¿ç”¨
2. **é…ç½®å‘½ä»¤ç™½åå•**: ä¸¥æ ¼é™åˆ¶å…è®¸æ‰§è¡Œçš„å‘½ä»¤
3. **ç›‘æ§æ—¥å¿—**: è®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨å’Œå‘½ä»¤æ‰§è¡Œ
4. **å®šæœŸå®¡è®¡**: æ£€æŸ¥ç­–ç•¥é…ç½®å’Œæ‰§è¡Œæ—¥å¿—

#### 4.3 å¼€å‘ç¯å¢ƒå»ºè®®

1. **ä½¿ç”¨ AutoEdit Mode**: æé«˜å¼€å‘æ•ˆç‡ï¼ŒåŒæ—¶ä¿æŒå®‰å…¨æ£€æŸ¥
2. **é…ç½®å‘½ä»¤é»‘åå•**: ç¦æ­¢ `rm`ã€`sudo` ç­‰å±é™©å‘½ä»¤
3. **å¯ç”¨è·¯å¾„æ£€æŸ¥**: ç¡®ä¿ `allowed-path` æ£€æŸ¥å™¨æ­£å¸¸å·¥ä½œ
4. **æµ‹è¯•å®‰å…¨ç­–ç•¥**: åœ¨éƒ¨ç½²å‰å……åˆ†æµ‹è¯•ç­–ç•¥é…ç½®

### 5. å·²çŸ¥é™åˆ¶ä¸é£é™©

#### 5.1 è·¯å¾„éå†é˜²æŠ¤é™åˆ¶

- **é™åˆ¶**: `validatePathAccess` ä»…æ£€æŸ¥å·¥å…·å‚æ•°ä¸­çš„è·¯å¾„ï¼Œæ— æ³•é˜²æ­¢é€šè¿‡ Shell å‘½ä»¤æ„é€ çš„è·¯å¾„éå†
- **ç¤ºä¾‹**: `cd /tmp && rm -rf /workspace` å¯èƒ½ç»•è¿‡è·¯å¾„æ£€æŸ¥
- **ç¼“è§£**: ä½¿ç”¨å‘½ä»¤é»‘åå•ç¦æ­¢ `cd` å‘½ä»¤

#### 5.2 å‘½ä»¤æ³¨å…¥é˜²æŠ¤é™åˆ¶

- **é™åˆ¶**: æ— æ³•é˜²æ­¢é€šè¿‡ Shell å˜é‡ã€å‡½æ•°ç­‰åŠ¨æ€æ–¹å¼æ„é€ å±é™©å‘½ä»¤
- **ç¤ºä¾‹**: `CMD="rm -rf /"; $CMD` å¯èƒ½ç»•è¿‡å‘½ä»¤é»‘åå•
- **ç¼“è§£**: ä½¿ç”¨ä¸¥æ ¼çš„å‘½ä»¤ç™½åå•ï¼Œç¦æ­¢æ‰€æœ‰æœªæ˜ç¡®å…è®¸çš„å‘½ä»¤

#### 5.3 é‡å®šå‘é˜²æŠ¤é™åˆ¶

- **é™åˆ¶**: ä»…æ£€æµ‹ç®€å•çš„é‡å®šå‘ç¬¦å·ï¼ˆ`>`ã€`<`ï¼‰ï¼Œæ— æ³•é˜²æ­¢é€šè¿‡ç®¡é“ã€tee ç­‰æ–¹å¼ç»•è¿‡
- **ç¤ºä¾‹**: `cat /etc/passwd | tee /workspace/passwd` å¯èƒ½ç»•è¿‡é‡å®šå‘æ£€æµ‹
- **ç¼“è§£**: ä½¿ç”¨å‘½ä»¤é»‘åå•ç¦æ­¢ `tee` ç­‰å‘½ä»¤

#### 5.4 å®‰å…¨æ£€æŸ¥å™¨é™åˆ¶

- **é™åˆ¶**: å®‰å…¨æ£€æŸ¥å™¨ä»…åœ¨å†³ç­–ä¸º `ALLOW` æˆ– `ASK_USER` æ—¶æ‰§è¡Œï¼Œå¦‚æœç­–ç•¥å†³ç­–å·²ç»æ˜¯ `DENY`ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œæ£€æŸ¥å™¨
- **ç¤ºä¾‹**: YOLO æ¨¡å¼ä¸‹ï¼Œç”±äºä¼˜å…ˆçº§é—®é¢˜ï¼Œå®‰å…¨æ£€æŸ¥å™¨å¯èƒ½æœªç”Ÿæ•ˆ
- **ç¼“è§£**: ç¡®ä¿å®‰å…¨æ£€æŸ¥å™¨çš„ä¼˜å…ˆçº§é«˜äº YOLO çš„å…è®¸è§„åˆ™

---

## é™„å½•

### A. é…ç½®æ–‡ä»¶ç¤ºä¾‹

#### A.1 å®Œæ•´çš„å®‰å…¨ç­–ç•¥é…ç½®

```toml
# ~/.gemini/policies/security.toml

# ç¦æ­¢å±é™©å‘½ä»¤
[[rule]]
toolName = "run_shell_command"
commandRegex = "^(rm|sudo|dd|mkfs|fdisk)\\s+.*"
decision = "deny"
priority = 999
deny_message = "Dangerous commands are not allowed."

# åªå…è®¸ git å’Œ ls å‘½ä»¤
[[rule]]
toolName = "run_shell_command"
commandPrefix = ["git status", "git log", "git diff", "ls"]
decision = "allow"
priority = 20

# åœ¨ AutoEdit æ¨¡å¼ä¸‹å¯ç”¨å®‰å…¨æ£€æŸ¥å™¨
[[rule]]
toolName = "write_file"
decision = "allow"
priority = 15
modes = ["autoEdit"]

[rule.safety_checker]
type = "in-process"
name = "allowed-path"
required_context = ["environment"]

[[rule]]
toolName = "replace"
decision = "allow"
priority = 15
modes = ["autoEdit"]

[rule.safety_checker]
type = "in-process"
name = "allowed-path"
required_context = ["environment"]
```

#### A.2 è®¾ç½®æ–‡ä»¶ç¤ºä¾‹

```json
{
  "tools": {
    "allowed": ["read_file", "list_directory", "search_file_content"],
    "exclude": ["run_shell_command", "web_fetch"]
  },
  "security": {
    "folderTrust": {
      "enabled": true
    },
    "disableYoloMode": false
  }
}
```

### B. å‘½ä»¤è¡Œå‚æ•°ç¤ºä¾‹

```bash
# åªå…è®¸è¯»å–å’Œæœç´¢å·¥å…·
gemini --allowed-tools=read_file,list_directory,search_file_content

# å…è®¸ç‰¹å®šçš„ Shell å‘½ä»¤
gemini --allowed-tools="ShellTool(git status),ShellTool(git log)"

# ç¦æ­¢ Shell å·¥å…·
gemini --allowed-tools=read_file,write_file,replace

# ä½¿ç”¨ YOLO æ¨¡å¼ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
gemini --yolo

# ä½¿ç”¨ AutoEdit æ¨¡å¼
gemini --approval-mode=auto_edit

# ä½¿ç”¨ Plan æ¨¡å¼
gemini --approval-mode=plan
```

---

## ç»“è®º

Gemini CLI å®ç°äº†å¤šå±‚æ¬¡çš„å®‰å…¨é˜²æŠ¤æœºåˆ¶ï¼ŒåŒ…æ‹¬å·¥å…·çº§é»‘ç™½åå•ã€ç­–ç•¥è§„åˆ™åŒ¹é…ã€å‘½ä»¤çº§é»‘ç™½åå•ã€è·¯å¾„è®¿é—®æ§åˆ¶ã€å®‰å…¨æ£€æŸ¥å™¨å’Œç”¨æˆ·ç¡®è®¤ã€‚ä¸åŒæ¨¡å¼ä¸‹çš„å®‰å…¨çº§åˆ«ä¸åŒï¼Œç”¨æˆ·åº”æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„æ¨¡å¼ï¼Œå¹¶é…ç½®ç›¸åº”çš„å®‰å…¨ç­–ç•¥ã€‚

**å…³é”®å‘ç°**:
1. **Shell Mode ä¸æ˜¯ç‹¬ç«‹æ¨¡å¼**ï¼Œè€Œæ˜¯ä¾èµ–å½“å‰æ¿€æ´»çš„ ApprovalMode
2. **AutoEdit æ¨¡å¼åªæå‡äº†æ–‡ä»¶æ“ä½œæƒé™**ï¼Œæœªæå‡ Shell å‘½ä»¤æƒé™
3. **å®‰å…¨æ£€æŸ¥å™¨åœ¨ AutoEdit æ¨¡å¼ä¸‹ç”Ÿæ•ˆ**ï¼Œä½†åœ¨ YOLO æ¨¡å¼ä¸‹ç”±äºä¼˜å…ˆçº§é—®é¢˜å¯èƒ½æœªç”Ÿæ•ˆ
4. **è·¯å¾„è®¿é—®æ§åˆ¶æ˜¯æ ¸å¿ƒé˜²æŠ¤æœºåˆ¶**ï¼Œä½†å­˜åœ¨ç»•è¿‡é£é™©
5. **å‘½ä»¤çº§é»‘ç™½åå•æ˜¯çµæ´»çš„é˜²æŠ¤æ‰‹æ®µ**ï¼Œä½†éœ€è¦è°¨æ…é…ç½®

**å»ºè®®**:
1. ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Default Modeï¼Œé…ç½®ä¸¥æ ¼çš„é»‘ç™½åå•
2. è‡ªåŠ¨åŒ–ç¯å¢ƒè°¨æ…ä½¿ç”¨ YOLO Modeï¼Œé…ç½®å‘½ä»¤ç™½åå•
3. å®šæœŸå®¡è®¡ç­–ç•¥é…ç½®å’Œæ‰§è¡Œæ—¥å¿—
4. æµ‹è¯•å®‰å…¨ç­–ç•¥çš„æœ‰æ•ˆæ€§

---

**æ–‡æ¡£ç»“æŸ**
